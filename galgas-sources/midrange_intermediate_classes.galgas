

#----------------------------------------------------*

struct @midrange_intermediate_registerExpression {
  public var @string mAssemblyString
  public var @uint mRegisterAddress # xxx bit full address
}

#----------------------------------------------------*

method @registerExpression resolveMidrangeAccess
  ?let @uint inTotalBankCount
  ?let @uint inCurrentBank
  ?let @registerTable inRegisterTable
  ?let @constantMap inConstantMap
  !@midrange_intermediate_registerExpression outIPICregisterDescription
  !@bitSliceTable outBitSliceTable
  ?!@stringset ioUsedRegisters
{
  [self.mOffset eval !inRegisterTable !inConstantMap ?let @sint64 offset !?ioUsedRegisters]
  ioUsedRegisters += !self.mRegisterName.string
#--- Build assembly string
  var @string assemblyString = self.mRegisterName.string
  if offset > 0 then
    assemblyString += " + " + [[offset uint] hexString]
  end
#--- 
  [inRegisterTable searchKey
    !self.mRegisterName
    ?let @uintlist registerAddressList
    ?let @uint size
    ?outBitSliceTable
    ?*
    ?let protection
  ]
  [inRegisterTable checkPrivateAccess !self.mRegisterName !write:true !protection]
#---
  if [offset uint] >= size then
    error self.mEndOfOffsetExpression: "maximum index value is " + (size - 1)
  end
#--- Find acceptable bank settings
  var acceptableBanks =@uintlist ยง[]
  for (mValue) in  registerAddressList do
    acceptableBanks += !mValue >> 7
  end
#---
  var @uint registerAddress = 0
  if inCurrentBank == @uint. max then
  #--- No selected bank, register should be mirrored in all banks
    var @uint bank = 0
    var @bool ok = true
    loop( inTotalBankCount) while (bank < inTotalBankCount) & ok do
      ok = false
      for (mValue) in  registerAddressList while not ok do
        ok = (mValue >= (bank * 128)) & (mValue < (bank * 128 + 128))
        registerAddress = mValue & 0x7F
      end
      bank += 1
    end
    if not ok then
      var @string acceptableBankMessage = ""
      for (mValue) in  registerAddressList
      do acceptableBankMessage += [mValue >> 7 string]
      between acceptableBankMessage += ", "
      end
      error self.mRegisterName:"as no bank is currently known, the '" + self.mRegisterName + "' register accessible from bank "+ acceptableBankMessage  + ", but should be able to be accessed from any bank setting"
    end
  else
    var @bool found = false
    for (mValue) in  registerAddressList while not found do
      found = (mValue >= (inCurrentBank * 128)) & (mValue < (inCurrentBank * 128 + 128))
      registerAddress = mValue & 0x7F
    end
    if not found then
      var @string acceptableBankMessage = ""
      for (mValue) in  registerAddressList
      do acceptableBankMessage += [mValue >> 7 string]
      between acceptableBankMessage += ", "
      end
      error self.mRegisterName:"the '" + self.mRegisterName + "' register cannot be accessed from bank " + [inCurrentBank string] + " (valid bank setting: " + acceptableBankMessage + ")"
    end
  end
#---
  outIPICregisterDescription = @midrange_intermediate_registerExpression.init {
    !assemblyString
    !registerAddress + [offset uint]}
}

#----------------------------------------------------*

abstract refclass @midrange_intermediate_instruction {
}

#----------------------------------------------------*

list @midrange_intermediate_instructionList {
  public var @midrange_intermediate_instruction mInstruction
}

#----------------------------------------------------*

refclass @midrange_intermediate_NULL : @midrange_intermediate_instruction {
}


#----------------------------------------------------*

refclass @midrange_intermediate_pseudo_ORG : @midrange_intermediate_instruction {
  public var @uint mOrigin
}

#----------------------------------------------------*

refclass @midrange_intermediate_pseudo_LABEL : @midrange_intermediate_instruction {
  public var @lstring mLabel
  public var @bool mIsDeletable
}

#----------------------------------------------------*

abstract refclass @midrange_intermediate_actualInstruction : @midrange_intermediate_instruction {
  public var @location mInstructionLocation
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_FD : @midrange_intermediate_actualInstruction {
  public var @midrange_instruction_FD_base_code mInstruction_FD_base_code
  public var @midrange_intermediate_registerExpression mRegisterDescription
  public var @bool m_W_isDestination
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_F : @midrange_intermediate_actualInstruction {
  public var @midrange_F_instruction_base_code mFinstruction
  public var @midrange_intermediate_registerExpression mRegisterDescription
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_FB : @midrange_intermediate_actualInstruction {
  public var @midrange_bit_oriented_op mBitOrientedOp
  public var @midrange_intermediate_registerExpression mRegisterDescription
  public var @uint mBitNumber
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_BitTestSkip : @midrange_intermediate_actualInstruction {
  public var @bool mSkipIfSet
  public var @midrange_intermediate_registerExpression mRegisterDescription
  public var @uint mBitNumber
}

#----------------------------------------------------*

enum @midrange_call_goto_bit {
  case set  case clear  case noChange
}

#----------------------------------------------------*

refclass @midrange_intermediate_JUMP : @midrange_intermediate_actualInstruction {
  public var @lstring mTargetLabel
  public var @midrange_call_goto_bit mBit11
  public var @midrange_call_goto_bit mBit12
}

#----------------------------------------------------*

refclass @midrange_intermediate_GOTO : @midrange_intermediate_actualInstruction {
  public var @lstring mTargetLabel
}

#----------------------------------------------------*

refclass @midrange_intermediate_CALL : @midrange_intermediate_actualInstruction {
  public var @lstring mTargetLabel
}

#----------------------------------------------------*

refclass @midrange_intermediate_JSR : @midrange_intermediate_actualInstruction {
  public var @lstring mTargetLabel
  public var @midrange_call_goto_bit mBit11
  public var @midrange_call_goto_bit mBit12
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_CLRWDT : @midrange_intermediate_actualInstruction {
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_CLRW : @midrange_intermediate_actualInstruction {
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_NOP : @midrange_intermediate_actualInstruction {
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_RETURN : @midrange_intermediate_actualInstruction {
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_RETFIE : @midrange_intermediate_actualInstruction {
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_SLEEP : @midrange_intermediate_actualInstruction {
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_literalOperation : @midrange_intermediate_actualInstruction {
  public var @midrange_literal_instruction_opcode mLiteralInstruction
  public var @uint mLiteralValue
}

#----------------------------------------------------*

refclass @midrange_intermediate_instruction_MNOP : @midrange_intermediate_actualInstruction {
  public var @luint mOccurrenceFactor
}

#----------------------------------------------------*

refclass @midrange_intermediate_incDecRegisterInCondition : @midrange_intermediate_actualInstruction {
  public var @midrange_intermediate_registerExpression mRegisterDescription
  public var @string mTargetLabel
  public var @bool mIncrement
  public var @bool m_W_isDestination
  public var @bool mBranchIfZero
}

#----------------------------------------------------*

