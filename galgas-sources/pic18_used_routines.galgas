

#---------------------------------------------------------------------------*

abstract method @pic18PiccoloInstruction addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines

#---------------------------------------------------------------------------*

override method @pic18Instruction_IF_BitTest addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  [mEmbeddedInstruction addUsedRoutines !inMacroMap !?ioUsedRoutines]
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_IF_FA_SEMI_COLON addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  [mEmbeddedInstruction addUsedRoutines !inMacroMap !?ioUsedRoutines]
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_IF_IncDec addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  [mEmbeddedInstruction addUsedRoutines !inMacroMap !?ioUsedRoutines]
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_JUMP addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset ioUsedRoutines
{
  ioUsedRoutines += !mTargetLabel.string
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_JUMPCC addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset ioUsedRoutines
{
  ioUsedRoutines += !mTargetLabel.string
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_FOREVER addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?ioUsedRoutines )
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_repetitionStatique addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?ioUsedRoutines )
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_checkbank addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_LDATAPTR addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_LTBLPTR addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_MNOP addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_banksel addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_checknobank addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_banksel_register addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_bra addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset ioUsedRoutines
{
  for () in  mTargetLabels do
    ioUsedRoutines += !mValue.string
  end
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_goto addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset ioUsedRoutines
{
  for () in  mTargetLabels do
    ioUsedRoutines += !mValue.string
  end
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_rcall addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset ioUsedRoutines
{
  for () in  mTargetLabels do
    ioUsedRoutines += !mValue.string
  end
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_retlw addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_do_while addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  addPic18UsedRoutinesFromInstructionList (!mRepeatedInstructionList !inMacroMap !?ioUsedRoutines )
  for () in  mWhilePartList do
    addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?ioUsedRoutines )
  end
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_nobanksel addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_savebank addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  addPic18UsedRoutinesFromInstructionList ( !mInstructionList !inMacroMap !?ioUsedRoutines )
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_structured_if addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  addPic18UsedRoutinesFromInstructionList (!mThenInstructionList !inMacroMap !?ioUsedRoutines )
  addPic18UsedRoutinesFromInstructionList (!mElseInstructionList !inMacroMap !?ioUsedRoutines )
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_switch addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  for () in  mCaseList do
    addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?ioUsedRoutines )
  end
  addPic18UsedRoutinesFromInstructionList (!mElseInstructionList !inMacroMap !?ioUsedRoutines )
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_with addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?ioUsedRoutines)
}
#---------------------------------------------------------------------------*

override method @pic18Instruction_macro addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  [inMacroMap searchKey !mMacroName ?* ?let instructionList]
  addPic18UsedRoutinesFromInstructionList (!instructionList !inMacroMap !?ioUsedRoutines)
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_FA addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_FBA addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_FDA addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_JSR addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset ioUsedRoutines
{
  ioUsedRoutines += !mTargetLabel.string
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_LFSR addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_MOVFF addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_TBLWT addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_TBLRD addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_literalOperation addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_fnop addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_withNoOperand addUsedRoutines
  ?let @pic18MacroMap unused inMacroMap
  ?!@stringset unused ioUsedRoutines
{
}

#---------------------------------------------------------------------------*

override method @pic18Instruction_block addUsedRoutines
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  for () in  mBlockList do
    addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?ioUsedRoutines )
  end
}

#---------------------------------------------------------------------------*

proc addPic18UsedRoutinesFromInstructionList
  ?let @pic18InstructionList inInstructionList
  ?let @pic18MacroMap inMacroMap
  ?!@stringset ioUsedRoutines
{
  for () in  inInstructionList do
    [mInstruction addUsedRoutines !inMacroMap !?ioUsedRoutines]
  end
}

#---------------------------------------------------------------------------*

func pic18_computeUsedRoutines
  ?let @pic18InterruptDefinitionList inInterruptDefinitionList
  ?let @pic18RoutineDefinitionList inRoutineDefinitionList
  ?let @pic18MacroMap inMacroMap
  ?let @routineDeclarationList inBootloaderRoutineDeclarationListForBootloaderImplementation
  ?let @routineDeclarationList inUserRoutineDeclarationListForUserProgramImplementation
  -> @stringset outUsedRoutineSet {
#--- Main routine is used
  outUsedRoutineSet = @stringset. setWithString { !"main"}
#--- Routines called by interrupt routines are used
  for () in  inInterruptDefinitionList do
    addPic18UsedRoutinesFromInstructionList (
      !mInstructionList
      !inMacroMap
      !?outUsedRoutineSet
    )  
  end
#--- bootloader routines are used
  for () in  inBootloaderRoutineDeclarationListForBootloaderImplementation do
    outUsedRoutineSet += !mRoutineName.string
  end
#--- user routines are used
  for () in  inUserRoutineDeclarationListForUserProgramImplementation do
    outUsedRoutineSet += !mRoutineName.string
  end
#--- Loop for accumulating used routines
  var s =@stringset.emptySet{}
  loop( [inRoutineDefinitionList length])
  while s != outUsedRoutineSet do
    s = outUsedRoutineSet
    for () in  inRoutineDefinitionList do
      if [outUsedRoutineSet hasKey !mRoutineName.string] then
        addPic18UsedRoutinesFromInstructionList (!mInstructionList !inMacroMap !?outUsedRoutineSet)
      end
    end
  end
}

#---------------------------------------------------------------------------*

