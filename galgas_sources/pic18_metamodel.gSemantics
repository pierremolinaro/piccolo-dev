semantics pic18_metamodel :
import "generic_metamodel.gSemantics" ;

#---------------------------------------------------------------------------*
#                                                                           *
#    B O O T L O A D E R   R E S E R V E D   R A M    M A P                 *
#                                                                           *
#---------------------------------------------------------------------------*

map @bootloaderReservedRAMmap {
  @luint mReservedSize ;
  insert insertKey error message "the reserved size for the '%K' bank is already declared" ;
  search searchKey error message "the reserved size for the '%K' bank is not declared" ;
}

#----------------------------------------------------*

abstract class @piccolo_instruction {
  @location mInstructionLocation ;
}

#----------------------------------------------------*

list @instructionList {
  @piccolo_instruction mInstruction ;
}

#----------------------------------------------------*

class @instruction_nobanksel extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_banksel extends @piccolo_instruction {
  @luint mBankIndex ;
}

#----------------------------------------------------*

class @instruction_savebank extends @piccolo_instruction {
  @registerExpression mRegister ;
  @instructionList mInstructionList ;
  @location mEndOfSaveBankInstruction ;
}

#----------------------------------------------------*

enum @instruction_FDA_base_code {
  ADDWF, ADDWFC, ANDWF, COMF, DECF, DECFSZ, DCFSNZ, INCF, INCFSZ, INFSNZ,
  IORWF, MOVF, RLCF, RLNCF, RRCF, RRNCF, SUBFWB, SUBWF, SUBWFB, SWAPF, XORWF
}{
}

#----------------------------------------------------*

class @instruction_FDA extends @piccolo_instruction {
  @instruction_FDA_base_code mInstruction_FDA_base_code ;
  @registerExpression mRegisterExpression ;
  @bool m_W_isDestination ;
}

#----------------------------------------------------*

enum @FA_instruction_base_code {
  CLRF, CPFSEQ, CPFSGT, CPFSLT, MOVWF, MULWF, NEGF, SETF, TSTFSZ
}{
}

#----------------------------------------------------*

class @instruction_FA extends @piccolo_instruction {
  @FA_instruction_base_code mFAinstruction ;
  @registerExpression mRegisterExpression ;
}

#----------------------------------------------------*

class @instruction_MOVFF extends @piccolo_instruction {
  @registerExpression mSourceRegisterName ;
  @registerExpression mDestinationRegisterName ;
}

#----------------------------------------------------*

enum @bit_oriented_op {
  BCF, BSF, BTG
}{
}

#----------------------------------------------------*

class @instruction_FBA extends @piccolo_instruction {
  @bit_oriented_op mBitOrientedOp ;
  @registerExpression mRegisterExpression ;
  @bitNumberExpression mBitNumber ;
}

#----------------------------------------------------*

enum @conditional_branch {
  bz, bnz, bn, bnn, bc, bnc, bov, bnov
}{
}

#----------------------------------------------------*

enum @jumpInstructionKind {
  ipicRelative, ipicAbsolute, relative, absolute
}{
}

#----------------------------------------------------*

class @instruction_JSR extends @piccolo_instruction {
  @lstring mTargetLabel ;
  @jumpInstructionKind mKind ;
}

#----------------------------------------------------*

class @instruction_JUMP extends @piccolo_instruction {
  @lstring mTargetLabel ;
  @jumpInstructionKind mKind ;
}

#----------------------------------------------------*

class @instruction_JUMPCC extends @piccolo_instruction {
  @lstring mTargetLabel ;
  @conditional_branch mConditionalBranch ;
  @bool mIsBcc ;
}

#----------------------------------------------------*

class @instruction_CLRWDT extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_DAW extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_NOP extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_POP extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_PUSH extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_RESET extends @piccolo_instruction {
}

#----------------------------------------------------*

class @instruction_SLEEP extends @piccolo_instruction {
}

#----------------------------------------------------*

enum @literal_instruction_opcode {
  ADDLW, ANDLW, IORLW, MOVLW, MULLW, SUBLW, XORLW
}{
}

#----------------------------------------------------*

class @instruction_literalOperation extends @piccolo_instruction {
  @literal_instruction_opcode mLiteralInstruction ;
  @immediatExpression mImmediatExpression ;
}

#----------------------------------------------------*

class @instruction_LFSR extends @piccolo_instruction {
  @luint mFSRindex ;
  @immediatExpression mImmediatExpression ;
}

#----------------------------------------------------*

class @instruction_LTBLPTR extends @piccolo_instruction {
  @immediatExpression mImmediatExpression ;
}

#----------------------------------------------------*

class @instruction_LDATAPTR extends @piccolo_instruction {
  @lstring mDataName ;
  @luint mDataIndex ;
}

#----------------------------------------------------*

enum @tableAccessOption {
  simpleAccess, postIncrement, postDecrement, preIncrement
}{
}

#----------------------------------------------------*

class @instruction_TBLRD extends @piccolo_instruction {
  @tableAccessOption mOption ;
}

#----------------------------------------------------*

class @instruction_TBLWT extends @piccolo_instruction {
  @tableAccessOption mOption ;
}

#----------------------------------------------------*

class @instruction_MNOP extends @piccolo_instruction {
  @luint mOccurrenceFactor ;
}

#----------------------------------------------------*

class @instruction_FOREVER extends @piccolo_instruction {
  @instructionList mInstructionList ;
  @location mEndOfInstructionList ;
}

#----------------------------------------------------*

enum @if_semi_colon_op {
  CPFSEQ, CPFSGT, CPFSLT, TSTFSZ
}{
}

#----------------------------------------------------*

abstract class @instruction_IF_SEMI_COLON extends @piccolo_instruction {
  @piccolo_instruction mInstruction ;
}

#----------------------------------------------------*

class @instruction_IF_FA_SEMI_COLON extends @instruction_IF_SEMI_COLON {
  @if_semi_colon_op mOpCode ;
  @registerExpression mRegisterExpression ;
}

#----------------------------------------------------*

class @instruction_IF_BitTest extends @instruction_IF_SEMI_COLON {
  @bool mSkipIfSet ;
  @registerExpression mRegisterExpression ;
  @bitNumberExpression mBitNumber ;
}

#----------------------------------------------------*

class @instruction_IF_IncDec extends @instruction_IF_SEMI_COLON {
  @bool mIncrement ;
  @bool mSkipIfZero ;
  @registerExpression mRegisterExpression ;
  @bool m_W_isDestination ;
}

#----------------------------------------------------*

class @instruction_computed_retlw extends @piccolo_instruction {
  @immediatExpression mSizeExpression ;
  @immediatExpressionList mImmediateExpressionList ;
  @bool mUsesRelativeCall ;
}

#----------------------------------------------------*

class @instruction_computed_bra extends @piccolo_instruction {
  @immediatExpression mSizeExpression ;
  @lstringlist mTargetLabels ;
  @bool mUsesRelativeCall ;
}

#----------------------------------------------------*

class @instruction_computed_goto extends @piccolo_instruction {
  @immediatExpression mSizeExpression ;
  @lstringlist mTargetLabels ;
  @bool mUsesRelativeCall ;
}

#----------------------------------------------------*

class @instruction_computed_rcall extends @piccolo_instruction {
  @immediatExpression mSizeExpression ;
  @lstringlist mTargetLabels ;
  @bool mUsesRelativeCall ;
}

#----------------------------------------------------*

abstract class @conditionExpression {
}

#----------------------------------------------------*

class @registerTestCondition extends @conditionExpression {
  @registerExpression mRegisterExpression ;
  @bool mBranchIfZero ;
}

#----------------------------------------------------*

enum @registerComparison {
  notEqual, equal, greaterOrEqual, greater, lowerOrEqual, lower
}{
}

#----------------------------------------------------*

class @registerComparisonCondition extends @conditionExpression {
  @registerExpression mRegisterExpression ;
  @registerComparison mComparison ;
}

#----------------------------------------------------*

class @incDecRegisterInCondition extends @conditionExpression {
  @registerExpression mRegisterExpression ;
  @bool mIncrement ;
  @bool m_W_isDestination ;
  @bool mBranchIfZero ;
}

#----------------------------------------------------*

class @bcc_in_structured_if_condition extends @conditionExpression {
  @conditional_branch mCondition ;
}

#----------------------------------------------------*

class @negateCondition extends @conditionExpression {
  @conditionExpression mCondition ;
}

#----------------------------------------------------*

class @andCondition extends @conditionExpression {
  @conditionExpression mLeftExpression ;
  @conditionExpression mRightExpression ;
}

#----------------------------------------------------*

class @bitTest_in_structured_if_condition extends @conditionExpression {
  @registerExpression mRegisterExpression ;
  @bitNumberExpression mBitNumber ;
  @bool mBTFSSinstruction ;
}

#----------------------------------------------------*

class @instruction_structured_if extends @piccolo_instruction {
  @conditionExpression mIfCondition ;
  @instructionList mThenInstructionList ;
  @instructionList mElseInstructionList ;
  @location mEndOfElsePartLocation ;
}

#----------------------------------------------------*

list @partList {
  @conditionExpression mCondition ;
  @instructionList mInstructionList ;
  @location mEndOfPartLocation ;
}

#----------------------------------------------------*

class @instruction_do_while extends @piccolo_instruction {
  @instructionList mRepeatedInstructionList ;
  @location mEndOfRepeatedInstructionList ;
  @partList mWhilePartList ;
}

#----------------------------------------------------*

list @interruptDefinitionList {
  @lstring mInterruptName ;
  @bool mFastReturn ;
  @instructionList mInstructionList ;
  @location mEndOfInterruptLocation ;
}

#----------------------------------------------------*

list @routineDefinitionList {
  @lstring mRoutineName ;
  @luint mRequiredBank ;
  @luint mReturnedBank ;
  @bool mPreservesBank ;
  @bool mIsNoReturn ;
  @instructionList mInstructionList ;
  @location mEndOfRoutineLocation ;
}

#----------------------------------------------------*

list @routineDeclarationList {
  @lstring mRoutineName ;
  @luint mRequiredBank ;
  @luint mReturnedBank ;
  @bool mPreservesBank ;
  @bool mIsNoReturn ;
}

#----------------------------------------------------*

enum @programKind {
  regularProgram, bootloaderProgram, userProgram
}{
}

#----------------------------------------------------*

list @dataList {
  @lstring mDataName ;
  @luintlist mValueList ;
}

#----------------------------------------------------*

struct @piccoloModel {
  @lstring mProgramName ;
  @programKind mProgramKind ;
  @lstring mDeviceNameOrBootLoaderReference ;
  @configDefinitionList mConfigDefinitionList ;
  @ramDefinitionList mRamDefinitionList ;
  @dataList mDataList ;
  @interruptDefinitionList mInterruptDefinitionList ;
  @constantDefinitionList mConstantDefinitionList ;
  @routineDefinitionList mRoutineDefinitionList ;
  @bool mNeedsComputedGoto2 ;
  @bool mNeedsComputedGoto4 ;
  @location mEndOfProgram ;
}

#----------------------------------------------------*

end semantics ;
