semantics pic18_used_routines :
import "pic18_metamodel.gSemantics" ;

#---------------------------------------------------------------------------*

abstract method @pic18PiccoloInstruction addUsedRoutines
  ?!@stringset ioUsedRoutines
;

#---------------------------------------------------------------------------*

override method @pic18Instruction_IF_BitTest addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  [mEmbeddedInstruction addUsedRoutines !?ioUsedRoutines] ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_IF_FA_SEMI_COLON addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  [mEmbeddedInstruction addUsedRoutines !?ioUsedRoutines] ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_IF_IncDec addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  [mEmbeddedInstruction addUsedRoutines !?ioUsedRoutines] ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_JUMP addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  ioUsedRoutines += !mTargetLabel->string ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_JUMPCC addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  ioUsedRoutines += !mTargetLabel->string ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_FOREVER addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  addPic18UsedRoutinesFromInstructionList !mInstructionList !?ioUsedRoutines ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_checkbank addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_LDATAPTR addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_LTBLPTR addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_MNOP addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_banksel addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_banksel_register addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_bra addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  foreach mTargetLabels do
    ioUsedRoutines += !mValue->string ;
  end foreach ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_goto addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  foreach mTargetLabels do
    ioUsedRoutines += !mValue->string ;
  end foreach ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_rcall addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  foreach mTargetLabels do
    ioUsedRoutines += !mValue->string ;
  end foreach ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_computed_retlw addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_do_while addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  addPic18UsedRoutinesFromInstructionList !mRepeatedInstructionList !?ioUsedRoutines ;
  foreach mWhilePartList do
    addPic18UsedRoutinesFromInstructionList !mInstructionList !?ioUsedRoutines ;
  end foreach ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_nobanksel addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_savebank addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  addPic18UsedRoutinesFromInstructionList !mInstructionList !?ioUsedRoutines ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_structured_if addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  addPic18UsedRoutinesFromInstructionList !mThenInstructionList !?ioUsedRoutines ;
  addPic18UsedRoutinesFromInstructionList !mElseInstructionList !?ioUsedRoutines ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_FA addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_FBA addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_FDA addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_JSR addUsedRoutines
  ?!@stringset ioUsedRoutines
:
  ioUsedRoutines += !mTargetLabel->string ;
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_LFSR addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_MOVFF addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_TBLWT addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_TBLRD addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_literalOperation addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

override method @pic18Instruction_withNoOperand addUsedRoutines
  ?!@stringset unused ioUsedRoutines
:
end method ;

#---------------------------------------------------------------------------*

local routine addPic18UsedRoutinesFromInstructionList
  ??@pic18InstructionList inInstructionList
  ?!@stringset ioUsedRoutines
:
  foreach inInstructionList do
    [mInstruction addUsedRoutines !?ioUsedRoutines] ;
  end foreach ;
end routine ;

#---------------------------------------------------------------------------*

function pic18_computeUsedRoutines
  ??@pic18InterruptDefinitionList inInterruptDefinitionList
  ??@pic18RoutineDefinitionList inRoutineDefinitionList
  ??@routineDeclarationList inBootloaderRoutineDeclarationListForBootloaderImplementation
  ??@routineDeclarationList inUserRoutineDeclarationListForUserProgramImplementation
  -> @stringset outUsedRoutineSet
:
#--- Main routine is used
  outUsedRoutineSet := [@stringset setWithString !"main"] ;
#--- Routines called by interrupt routines are used
  foreach inInterruptDefinitionList do
    addPic18UsedRoutinesFromInstructionList
      !mInstructionList
      !?outUsedRoutineSet
    ;  
  end foreach ;
#--- bootloader routines are used
  foreach inBootloaderRoutineDeclarationListForBootloaderImplementation do
    outUsedRoutineSet += !mRoutineName->string ;
  end foreach ;
#--- user routines are used
  foreach inUserRoutineDeclarationListForUserProgramImplementation do
    outUsedRoutineSet += !mRoutineName->string ;
  end foreach ;
#--- Loop for accumulating used routines
  @stringset s [emptySet] ;
  loop [inRoutineDefinitionList length] :
  while s != outUsedRoutineSet do
    s := outUsedRoutineSet ;
    foreach inRoutineDefinitionList do
      if [outUsedRoutineSet hasKey !mRoutineName->string] then
        addPic18UsedRoutinesFromInstructionList !mInstructionList !?outUsedRoutineSet ;
      end if ;
    end foreach ;
  end loop ;
end function ;

#---------------------------------------------------------------------------*

end semantics ;
